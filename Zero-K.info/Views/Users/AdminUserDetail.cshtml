@using ZeroKWeb
@using ZkData
@model ZkData.Account

@{
    Page.Title = Model.Name + " User Administration";

    var brokenIDs = new List<Int64>() { 1236934115, 1199297835, -2130083051, 195445522, 1141552226 };
    var smurfs = Model.GetSmurfs();

    Int64? lastUserID = null;
    if (Model.AccountUserIDs.Any())
    {
        lastUserID = Model.AccountUserIDs.OrderByDescending(x => x.LastLogin).FirstOrDefault().UserID;
    }

    string lastInstallID = null;
    if (Model.AccountUserIDs.Any())
    {
        lastInstallID = Model.AccountUserIDs.OrderByDescending(x => x.LastLogin).FirstOrDefault().InstallID;
    }
}           

<style>
    body {
        font-family: "OpenSans", sans-serif;
    }
    h1 {
        margin-bottom: 1em;
    }
    form {
        border: 1px dotted magenta;
        margin: 1em;
    }
    .group {
        background: rgba(0,0,0,0.75);
        padding: 1em;
        margin: 1em;
    }
    .infokey {
        display: inline-block;
        width: 10em;
        font-weight: bold;
    }
    .infovalue, .infovalue form {
        display: inline-block;
    }
    .infovalue form input {
        margin: 0;
        margin-left: 2em;
    }
    .purge form {
        background: rgba(0,0,0,0.5);
        padding: 1em;
        margin: 1em;
    }
</style>

<div class="">
    <div class="group user-info">
        <h1>Administration: @Html.PrintAccount(@Model, true, true)</h1>
        <div><span class="infokey">Account Id:</span> <span class="infovalue">@Model.AccountID</span></div>
        <div>
            <span class="infokey">Steam Id:</span>
            <div class="infovalue">
                @if (Model.SteamID == null)
                {
                    <span>Not linked with Steam</span>
                }
                else
                {
                    <span>@Model.SteamID</span>
                    <form method="post" action="@Url.Action("UnlinkSteamID", "Users", new { accountID = Model.AccountID })">
                        @Html.AntiForgeryToken()
                        <input type="submit" value="Unlink Steam Account" class="js_confirm" />
                    </form>
                }
            </div>
        </div>
        <div><span class="infokey">Lobby Version:</span> <span class="infovalue">@(Model.LobbyVersion ?? "Not Available")</span></div>
        <div><span class="infokey">Last Login:</span> <span class="infovalue">@Model.LastLogin</span></div>
        <div><span class="infokey">Last Logout:</span> <span class="infovalue">@Model.LastLogout</span></div>
        <div><span class="infokey">Last Chat Read:</span> <span class="infovalue">@Model.LastChatRead</span></div>

        <div class="group">
            <h3>Smurfs</h3>
            @foreach (var ac in smurfs)
            {
                <div>
                    <span>@Html.PrintAccount(ac, true, true)  -  @Html.ActionLink("admin", "AdminUserDetail", new { id = ac.AccountID })</span>
                    @if (ac.PunishmentsByAccountID.Any(x => x.BanExpires > DateTime.UtcNow && x.BanLobby))
                    {
                        <font color="#FF0000"><b>(BANNED)</b></font>
                    }
                </div>
            }
        </div>
        <div class="group">
            <h3>IP Addresses:</h3>
            <div>
                <table>
                    <thead>
                        <tr>
                            <th>IP</th>
                            <th>Count</th>
                            <th>First</th>
                            <th>Last</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (AccountIP x in Model.AccountIPs.OrderByDescending(x => x.LastLogin))
                        {
                            <tr>
                                <td>@x.IP</td>
                                <td>@x.LoginCount</td>
                                <td>@x.FirstLogin</td>
                                <td>@x.LastLogin</td>
                                <td><a target="_blank" href="http://whatismyipaddress.com/ip/@x.IP">Lookup IP</a> </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="group">
            <h3>User Ids:</h3>
            <table>
                <thead>
                    <tr>
                        <th>UserID</th>
                        <th>InstallID</th>
                        <th>Count</th>
                        <th>First</th>
                        <th>Last</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (AccountUserID x in Model.AccountUserIDs.OrderByDescending(x => x.LastLogin))
                    {
                        <tr>
                            <td>@x.UserID</td>
                            <td>@x.InstallID</td>
                            <td>@x.LoginCount</td>
                            <td>@x.FirstLogin</td>
                            <td>@x.LastLogin</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="group abuse-reports">
        <h1>Abuse reports</h1>
        <table>
            <tbody style="vertical-align:top; background-color:#222">
                @foreach (var a in Model.AbuseReportsByAccountID)
                {
                    <tr><td>@a.Time</td><td>@Html.PrintAccount(a.AccountByReporterAccountID, true, true)</td><td style="padding-bottom:25px;">@Html.BBCode(a.Text)</td></tr>
                }
            </tbody>
        </table>
    </div>
    <div class="group penalties">
        <h1>Penalties</h1>
        @if (Model.PunishmentsByAccountID.Any())
        {
            foreach (Punishment p in Model.PunishmentsByAccountID.Where(x => !x.IsExpired))
            {
                @Html.DisplayFor(x => p)
            }
        }
        <hr />
        <h2>Expired</h2>
        @if (Model.PunishmentsByAccountID.Any())
        {
            foreach (Punishment p in Model.PunishmentsByAccountID.Where(x => x.IsExpired))
            {
                @Html.DisplayFor(x => p)
            }
        }
    </div>
    <div class="group actions">
        <h1>Actions</h1>
        <div>
            <form method="post" action="@Url.Action("SetPassword", "Users", new { accountID = Model.AccountID })">
                @Html.AntiForgeryToken()
                <label for="newPassword">Set (Temporary) Password:</label>
                <input type="text" id="newPassword" name="newPassword" value="" />
                <input type="submit" value="Change Password" />
                <div>TODO: make this value set a flag on the account to have player forcibly update it themselves to something different.</div>
            </form>

            <form method="post" action="@Url.Action("SetUsername", "Users", new { accountID = Model.AccountID })">
                @Html.AntiForgeryToken()
                <label for="newUsername">Set Username:</label>
                <input type="text" id="newUsername" name="newUsername" value="Lobster" />
                <input type="submit" value="Change Username" />
            </form>

            <form method="post" action="@Url.Action("ChangeHideCountry", "Users", new { accountID = Model.AccountID })">
                @Html.AntiForgeryToken()
                <div class="permission">
                    <label class="switch">
                        @* @Html.CheckBox("hideCountry", Model.HideCountry) *@
                        <input id="hideCountry" name="hideCountry" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="hideCountry">Hide Country:</label>
                </div>
                <input type="submit" value="Apply" />
            </form>

            <form method="post" action="@Url.Action("ChangePermissions", "Users", new { accountID = Model.AccountID })">
                @Html.AntiForgeryToken()
                <div>TODO: this only available to superadmin? hide otherwise</div>
                <div class="permission">
                    <label class="switch">
                        @* @Html.CheckBox("zkAdmin", Model.AdminLevel >= AdminLevel.Moderator) *@
                        <input id="zkAdmin" name="zkAdmin" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="zkAdmin">Zero-K Admin</label>
                </div>
                <div class="permission">
                    <label class="switch">
                        @* @Html.CheckBox("tourneyController", Model.IsTourneyController) *@
                        <input id="tourneyController" name="tourneyController" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="tourneyController">Tourney Control</label>
                </div>
                <div class="permission">
                    <label class="switch">
                        @* @Html.CheckBox("vpnException", Model.HasVpnException) *@
                        <input id="vpnException" name="vpnException" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="vpnException">VPN Exception</label>
                </div>
                <input type="submit" value="Modify User" />
            </form>

        </div>
    </div>
    <div class="group penalties">
        <h1>Penalties</h1>
        <style>
            #punish > div {
                background: rgba(0,0,0,0.3);
                padding: 1em;
                margin-top: 1em;
            }
            .inline {
                display: inline-block;
            }
            .indent-1 {
                padding-left: 1em;
            }
            .indent-2 {
                padding-left: 2em;
            }
        </style>
        <script>

            function addPunishmentHours(hours) {
                hours = parseInt(hours);
                if (!hours) hours = 0;

                var oldHours = parseInt($("#banHours").val());
                if (!oldHours) oldHours = 0;

                var newHours = oldHours + hours;
                $("#banHours").val(newHours).change();
            }

            $(document).ready(function () {
                $("#punishTeamKill").click(function () {
                    $("#reason").val("Team Killing");
                    $("#banLobby").prop("checked", true);
                    addPunishmentHours(24);
                });
                $("#punishBanDodge").click(function () {
                    $("#reason").val("Ban Dodging");
                    $("#banLobby").prop("checked", true);
                    addPunishmentHours(24 * 7);
                });
                $("#punishBadChat").click(function () {
                    $("#reason").val("Offensive Chat");
                    $("#banMute").prop("checked", true);
                    addPunishmentHours(24);
                });
                $("#punishBadPost").click(function () {
                    $("#reason").val("Offensive Post");
                    $("#banForum").prop("checked", true);
                    addPunishmentHours(24);
                });

                $("#addDay").click(function () {
                    addPunishmentHours(24);
                });
                $("#addWeek").click(function () {
                    addPunishmentHours(24 * 7);
                });
                $("#addMonth").click(function () {
                    addPunishmentHours(24 * 30);
                });
                $("#banHours").change(function () {
                    var newHours = parseInt($("#banHours").val());
                    if (!newHours) {
                        $("#hourConversion").html("");
                        return;
                    }

                    var expireDate = new Date();
                    expireDate.setHours(expireDate.getHours() + newHours);
                    $("#hourConversion").html("Expires on " + expireDate.toLocaleString());
                });

                $("#resetPunishments").click(function () {
                    $("#reason").val("");
                    $("#banHours").val("").change();
                    $(".consequence input").prop("checked", false);
                });
            });
        </script>
        <form id="punish" action="@Url.Action("Punish", "Users", new { accountID = Model.AccountID })" method="post">
            @Html.AntiForgeryToken()
            @*Message only, not a penalty: @Html.CheckBox("messageOnly")<br />*@
            @*<br />
        Mute: @Html.CheckBox("banMute")<br />
        Block Votes: @Html.CheckBox("banVotes")<br />
        Block commanders: @Html.CheckBox("banCommanders")<br />
        Disallow spec chat: @Html.CheckBox("banSpecChat")<br />
        <br />
        Ban site: @Html.CheckBox("banSite")<br />
        Ban lobby: @Html.CheckBox("banLobby")<br />
        Ban forum: @Html.CheckBox("banForum")<br />*@

            @*<br />
        IP: @Html.TextBox("banIP", Model.AccountIPs.OrderByDescending(x => x.LastLogin).Select(x => x.IP).FirstOrDefault())<br />
        User ID: @Html.TextBox("banUserID", lastUserID != null && !brokenIDs.Contains((int)lastUserID) ? lastUserID.ToString() : "")<br />
        Install ID: @Html.TextBox("installID", lastInstallID)<br />*@

            <div class="who">
                TODO: fields to deal with smurf accounts
            </div>

            <div class="why">
                <input type="text" id="reason" name="reason" placeholder="Reason" style="width: 100%;" />
                <input type="button" id="submitMessage" class="inline" value="NIGHTWATCH MESSAGE" />
                <input type="button" id="submitWarning" class="inline" value="WARNING" />
                <input type="button" id="punishTeamKill" class="inline" value="+ Teamkilling" />
                <input type="button" id="punishBanDodge" class="inline" value="+ Ban Dodging" />
                <input type="button" id="punishBadChat" class="inline" value="+ Offensive Chat" />
                <input type="button" id="punishBadPost" class="inline" value="+ Offensive Post" />
            </div>

            <div class="when">
                <input type="text" id="banHours" name="banHours" class="inline" placeholder="Ban Duration (hours)" />
                <span id="hourConversion"></span>
                <br />
                <input type="button" id="addDay" class="inline" value="+ 1 day" />
                <input type="button" id="addWeek" class="inline" value="+ 1 week" />
                <input type="button" id="addMonth" class="inline" value="+ 1 month" />
            </div>

            <div class="what">
                <div class="consequence">
                    <label class="switch">
                        <input id="banLobby" name="banLobby" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="banLobby">Ban Lobby</label>
                </div>
                <div class="consequence indent-1">
                    <label class="switch">
                        <input id="banVotes" name="banVotes" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="banVotes">Block Votes</label>
                </div>
                <div class="consequence indent-1">
                    <label class="switch">
                        <input id="banCommanders" name="banCommanders" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="banCommanders">Block Commanders</label>
                </div>
                <div class="consequence indent-1">
                    <label class="switch">
                        <input id="banMute" name="banMute" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="banMute">Mute</label>
                </div>
                <div class="consequence indent-2">
                    <label class="switch">
                        <input id="banSpecChat" name="banSpecChat" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="banSpecChat">Spectator Mute</label>
                </div>
                <div class="consequence">
                    <label class="switch">
                        <input id="banSite" name="banSite" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="banSite">Ban Site</label>
                </div>
                <div class="consequence indent-1">
                    <label class="switch">
                        <input id="banForum" name="banForum" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                    <label for="banForum">Ban Forum</label>
                </div>
            </div>

            <div class="how">
                <div class="inline">
                    <label for="banIP">Block IP Address</label>
                    <input id="banIP" name="banIP" type="text" placeholder="IP Address" value="">
                </div>
                <div class="inline">
                    <label for="banUserID">Block User ID</label>
                    <input id="banUserID" name="banUserID" type="text" placeholder="User ID" value="">
                </div>
                <div class="inline">
                    <label for="installID">Block Install ID</label>
                    <input id="installID" name="installID" type="text" placeholder="Install ID" value="">
                </div>
            </div>

            <div>
                <input type="button" id="resetPunishments" class="inline" value="RESET" />
                <input type="submit" class="inline js_confirm" value="PUNISH" />
            </div>
        </form>
    </div>
    <div class="group purge">
        <h1>Purge</h1>
        <form method="post" action="@Url.Action("DeleteFromRatings", "Users", new { accountID = Model.AccountID })">
            @Html.AntiForgeryToken()
            <input type="submit" value="Delete User Rating" />
            This will remove every game this user participated in from the ratings. <br />
            It will impact every person this user played with and cannot be undone without rolling back the database!
        </form>

        <form method="post" action="@Url.Action("ChangeAccountDeleted", "Users", new { accountID = Model.AccountID })">
            @Html.AntiForgeryToken()
            <label for="isDeleted">Hide (Delete) Account</label>
            Deleted: @Html.CheckBox("isDeleted") <br />
            Move all games to account: @Html.TextBox("alias") <br />
            <input type="submit" />
        </form>

        <form method="post" action="@Url.Action("DeleteAllPostsByUser", "Forum", new { accountID = Model.AccountID })">
            @Html.AntiForgeryToken()
            This will <b>permanently</b> remove <b>all</b> of the user's posts.<br />
            This action <b>cannot</b> be undone!<br />
            <br />
            Enter the target's user name to confirm: @Html.TextBox("accountName")
            <input type="submit" value="Delete Forum Posts" class="js_confirm" />
        </form>

        <form method="post" action="@Url.Action("DeleteAllForumVotes", "Users", new { accountID = Model.AccountID })">
            @Html.AntiForgeryToken()
            This will <b>permanently</b> remove <b>all</b> of the user's upvotes/downvotes on forum.<br />
            This action <b>cannot</b> be undone!<br />
            <br />
            Enter the target's user name to confirm: @Html.TextBox("accountName")
            <input type="submit" value="Delete Forum Votes" class="js_confirm" />
        </form>
    </div>
</div>
